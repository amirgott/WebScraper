<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 md:p-12 rounded-xl shadow-lg w-full max-w-2xl">
        <!-- Main Heading -->
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 text-center">Event Aggregator Input</h1>
        <p class="text-gray-600 text-center mb-8">
            Enter event details below from various sources to begin the aggregation process.
        </p>

        <!-- Form Container -->
        <div class="flex flex-col space-y-6">

            <!-- Input Textbox -->
            <div>
                <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Text/URL Input
                </label>
                <textarea id="text-input" rows="4" placeholder="Enter plain text, or a URL (e.g., https://example.com/webinar)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"></textarea>
            </div>

            <!-- Image Placeholder (Drag & Drop) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Image (Drag & Drop or Paste)
                </label>
                <div id="image-placeholder" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 transition-colors h-48">
                    <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-2-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2h2m4-2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="image-text" class="text-gray-500 text-sm font-medium">Drag & Drop an image here or paste from clipboard</span>
                    <img id="image-preview" src="" alt="Image Preview" class="hidden mt-4 max-h-32 object-contain rounded-lg">
                </div>
                <!-- Hidden input for clipboard paste -->
                <input type="text" id="clipboard-paste-target" class="absolute left-0 top-0 opacity-0 -z-10" tabindex="-1">
            </div>

            <!-- PDF File Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    PDF File
                </label>
                <div class="flex items-center space-x-3">
                    <label class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        <span>Select File</span>
                        <input type="file" id="pdf-file-input" class="hidden" accept="application/pdf">
                    </label>
                    <span id="pdf-file-name" class="text-gray-500 text-sm">No file selected</span>
                </div>
            </div>

            <!-- Run Button -->
            <button id="run-button" class="w-full py-3 px-6 rounded-lg text-white font-bold tracking-wide transition-all duration-300 bg-gray-400 cursor-not-allowed" disabled>
                Run
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Processing Results</h2>
            <div id="results-content" class="bg-gray-50 p-4 rounded-lg min-h-48 whitespace-pre-wrap"></div>
            <div class="mt-4 flex space-x-3">
                <button id="write-to-sheet" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">Write to Sheet</button>
                <button id="improve-data" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded-lg">Improve</button>
            </div>
        </div>
    </div>

    <script>
        // Get references to all the form elements and the button
        const textInput = document.getElementById('text-input');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const imageText = document.getElementById('image-text');
        const pdfFileInput = document.getElementById('pdf-file-input');
        const pdfFileName = document.getElementById('pdf-file-name');
        const runButton = document.getElementById('run-button');
        const clipboardPasteTarget = document.getElementById('clipboard-paste-target');
        const resultsSection = document.getElementById('results-section');
        const resultsContent = document.getElementById('results-content');
        const writeToSheetButton = document.getElementById('write-to-sheet');
        const improveDataButton = document.getElementById('improve-data');

        let currentImageData = null;
        let currentProcessingResults = null;
        let currentRequestId = null;

        // Function to check if any input has content and enable/disable the button
        const checkInputs = () => {
            const isFilled = textInput.value.trim() !== '' || imagePreview.src !== '' || pdfFileInput.files.length > 0;
            if (isFilled) {
                runButton.disabled = false;
                runButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                runButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                runButton.disabled = true;
                runButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                runButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        };

        // Event listeners for changes in inputs
        textInput.addEventListener('input', checkInputs);
        pdfFileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                pdfFileName.textContent = event.target.files[0].name;
            } else {
                pdfFileName.textContent = 'No file selected';
            }
            checkInputs();
        });

        // Drag and Drop functionality for the image placeholder
        imagePlaceholder.addEventListener('dragover', (e) => {
            e.preventDefault();
            imagePlaceholder.classList.add('border-indigo-500', 'bg-indigo-50');
        });

        imagePlaceholder.addEventListener('dragleave', () => {
            imagePlaceholder.classList.remove('border-indigo-500', 'bg-indigo-50');
        });

        imagePlaceholder.addEventListener('drop', (e) => {
            e.preventDefault();
            imagePlaceholder.classList.remove('border-indigo-500', 'bg-indigo-50');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFile(file);
            }
        });

        // Clipboard paste functionality for the image placeholder
        imagePlaceholder.addEventListener('click', () => {
            clipboardPasteTarget.focus();
        });

        clipboardPasteTarget.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let imageFound = false;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    const blob = item.getAsFile();
                    handleImageFile(blob);
                    imageFound = true;
                    break;
                }
            }
            if (!imageFound) {
                const text = (e.clipboardData || e.originalEvent.clipboardData).getData('text');
                if (text) {
                    textInput.value = text;
                    checkInputs();
                }
            }
        });

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                imageText.classList.add('hidden');
                currentImageData = e.target.result;
                checkInputs();
            };
            reader.readAsDataURL(file);
        }

        // Run button event listener
        runButton.addEventListener('click', async () => {
            await processInputs();
        });

        // Write to sheet button event listener
        writeToSheetButton.addEventListener('click', async () => {
            if (currentRequestId) {
                await writeToSheet(currentRequestId);
            }
        });

        async function processInputs() {
            try {
                runButton.disabled = true;
                runButton.textContent = 'Processing...';

                const formData = new FormData();

                // Add text input
                if (textInput.value.trim()) {
                    formData.append('text_input', textInput.value.trim());
                }

                // Add image data
                if (currentImageData) {
                    formData.append('image_data', currentImageData);
                }

                // Add PDF file
                if (pdfFileInput.files.length > 0) {
                    formData.append('pdf_file', pdfFileInput.files[0]);
                }

                // Use the correct FastAPI server URL
                const baseUrl = window.location.hostname === 'localhost' && window.location.port === '63342' 
                    ? 'http://localhost:5000' 
                    : '';

                const response = await fetch(`${baseUrl}/api/run_scrape`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const results = await response.json();
                currentProcessingResults = results;
                currentRequestId = results.request_id;

                resultsContent.textContent = JSON.stringify(results, null, 2);
                resultsSection.classList.remove('hidden');

            } catch (error) {
                console.error('Error processing inputs:', error);
                alert('Error processing inputs: ' + error.message);
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'Run';
                checkInputs();
            }
        }

        async function writeToSheet(requestId) {
            try {
                writeToSheetButton.disabled = true;
                writeToSheetButton.textContent = 'Writing...';

                // Use the correct FastAPI server URL
                const baseUrl = window.location.hostname === 'localhost' && window.location.port === '63342' 
                    ? 'http://localhost:5000' 
                    : '';

                const response = await fetch(`${baseUrl}/api/write_to_sheet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ request_id: requestId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert('Successfully written to Google Sheets!');

                // Reset form
                resetForm();

            } catch (error) {
                console.error('Error writing to sheet:', error);
                alert('Error writing to sheet: ' + error.message);
            } finally {
                writeToSheetButton.disabled = false;
                writeToSheetButton.textContent = 'Write to Sheet';
            }
        }

        function resetForm() {
            textInput.value = '';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            imageText.classList.remove('hidden');
            pdfFileInput.value = '';
            pdfFileName.textContent = 'No file selected';
            currentImageData = null;
            currentProcessingResults = null;
            currentRequestId = null;
            resultsSection.classList.add('hidden');
            checkInputs();
        }

        // Initial check on page load
        checkInputs();
    </script>
</body>
</html>
